# artifactory-conf Role

This role is designed to override the default configuration files generated by the jfrog.platform collection roles. It is intended to be applied **after** the jfrog.platform roles (such as artifactory, artifactory_nginx_ssl, and postgres) have run, in order to replace the system.yaml and nginx configuration files with a set of known-working templates from a production system.

> **Warning:**  
> This role has not been fully tested in all environments. It is based on configuration files extracted from a working system. Use it at your own risk and verify the changes in a test environment before applying in production.

## How It Works

- **system.yaml.j2:**  
  This template generates a `system.yaml` file for Artifactory with the following characteristics:
  - Uses PostgreSQL as the database (with default connection parameters, which can be overridden).
  - Specifies security and node settings, including file paths for the join key and master key.
  - Leaves the `access` section empty.
  
- **artifactory.conf.j2:**  
  This template generates an nginx configuration file for Artifactory, which:
  - Defines two upstreams: one for the jf-router (`127.0.0.1:8082`) and one for direct Artifactory access (`127.0.0.1:8081`).
  - Enables SSL with TLSv1.2 and TLSv1.3, using certificates stored in `/etc/nginx/ssl/` (default names: `reconart_net_chain.crt` and `wildcard_reconart_net.key`).
  - Redirects requests from the root URL to `/ui/` and proxies traffic to the appropriate upstream.

## Role Structure

roles/
└── artifactory-conf/
    ├── tasks/
    │ └── main.yml
    ├── handlers/
    │ └── main.yml
    ├── templates/
    │   ├── system.yaml.j2
    │   └── artifactory.conf.j2
    └── README.md


## Usage

Include this role in your playbook **after** the jfrog.platform roles have been applied. For example:

```yaml
- hosts: artifactory_hosts
  become: yes
  vars_files:
    - ./vars/artifactory-secret-vars.yml
    - ./vars/artifactory-vars.yml
  collections:
    - jfrog.platform
  roles:
    - jfrog.platform.artifactory_nginx_ssl
    - jfrog.platform.postgres
    - jfrog.platform.artifactory
    - artifactory-conf
```

When the role runs, it will:

Render the system.yaml.j2 template and copy it to /opt/jfrog/artifactory/var/etc/system.yaml.
Render the artifactory.conf.j2 template and copy it to /etc/nginx/conf.d/artifactory.conf.
Notify handlers to restart the Artifactory service and reload nginx.


## Disclaimer

This role is based on configuration files extracted from a working system. It is provided as-is and has not been extensively tested in all environments. Please review and test the templates in your environment before deploying to production.

For any issues or improvements, please update this role accordingly.
